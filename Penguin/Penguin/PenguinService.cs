using System;
using System.IO;
using System.IO.Pipes;
using System.Security.Permissions;
using System.ServiceProcess;
using System.Threading;
using System.Diagnostics;
using static Penguin.ToApp;
using System.Security.AccessControl;
using System.Collections.Generic;
using System.Linq;

namespace Penguin
{
    public partial class PenguinService : ServiceBase
    {
        private static int numThreads = 5;
        static int i = 0;
        static Dictionary<int, string> ret = new Dictionary<int, string>();
        static object syncObj = new object();
        static Thread[] servers = new Thread[numThreads];
        static Dictionary<int, Thread> requests = new Dictionary<int, Thread>();

        static Dictionary<string, string> supers = new Dictionary<string, string>
        {
            { "Batman", "I'm Vengence! I'm the Night! I'm Batman!" },
            { "GreenLantern", "In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!In brightest day, in blackest night, No evil shall escape my sight.Let those who worship evil's might Beware my power--Green Lantern's light!" },
            { "Spiderman", "1" },
            { "Default", "Default Value"}
        };

        [PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
        public PenguinService()
        {
            InitializeComponent();
            //System.Timers.Timer timer = new System.Timers.Timer();

            File.WriteAllText(@"C:\Pipes\Test.txt", "Creating Pipe!");
            for (i = 0; i < numThreads; i++)
            {
                servers[i] = new Thread(PenguinService.ServerThread);
                requests.Add(servers[i].ManagedThreadId, new Thread(() => { }));
                ret.Add(servers[i].ManagedThreadId, "");
                servers[i].Start(i);
            }
        }

        public static void ServerThread(object i)
        {
            try
            {
                Thread.Sleep(1000);
                NamedPipeServerStream pipeServer = new NamedPipeServerStream("Riddler", PipeDirection.InOut, numThreads, PipeTransmissionMode.Message, PipeOptions.None, 8192, 8192, SetupPipeSecurity());
                StreamString ss = new StreamString(pipeServer);
                string key = "Default";
                while (true)
                {
                    try
                    {
                        if (pipeServer.IsConnected)
                        {
                            //l = Convert.ToInt32(i);
                            ss = new StreamString(pipeServer);
                            key = ss.ReadString();
                            File.AppendAllText(@"C:\Pipes\IO.txt", $"{ key } {supers[key]}\n");
                            lock (syncObj)
                            {
                                while (requests.Values.Where(request => request.IsAlive).Select(request => request).Count() > 0) ;
                                int freeThreadID = requests.Where(request => !request.Value.IsAlive).Select(request => request.Key).FirstOrDefault();

                                File.AppendAllText(@"C:\Pipes\IO.txt", $"\n { Thread.CurrentThread.ManagedThreadId } {freeThreadID} ");
                                foreach (var item in requests)
                                {
                                    File.AppendAllText(@"C:\Pipes\IO.txt", $"\n { item.Value.ManagedThreadId } {item.Value.ThreadState} ");
                                }
                                requests[freeThreadID] = new Thread(PenguinService.RequestThread);
                                requests[freeThreadID].Start($"{freeThreadID}|{key}");

                                Thread.Sleep(2000);
                                ss.WriteString(ret[freeThreadID] + ret[freeThreadID] + ret[freeThreadID] + ret[freeThreadID] + ret[freeThreadID] + ret[freeThreadID] + "EOM");
                                pipeServer.WaitForPipeDrain();
                                ss.Dispose();
                                pipeServer.Disconnect();
                            }
                        }
                        else
                        {
                            File.AppendAllText($@"C:\Pipes\Thread{Thread.CurrentThread.ManagedThreadId}.txt", "Waiting!");
                            pipeServer.WaitForConnection();
                            File.AppendAllText($@"C:\Pipes\Thread{Thread.CurrentThread.ManagedThreadId}.txt", "Got Connected!");
                        }
                    }
                    catch (Exception e)
                    {
                        pipeServer.Dispose();
                        pipeServer = new NamedPipeServerStream("Riddler", PipeDirection.InOut, numThreads, PipeTransmissionMode.Message, PipeOptions.None, 2048, 2048, SetupPipeSecurity());
                        File.AppendAllText(@"C:\Pipes\ServerInError.txt", $" { e.Message + " | " + e.StackTrace } ");
                    }
                }

            }
            catch (Exception e)
            {
                File.AppendAllText(@"C:\Pipes\ServerOutError.txt", $" { e.Message + " OUT| " + e.StackTrace } ");
            }
        }

        private static void RequestThread(object json)
        {
            int threadID = Convert.ToInt32(json.ToString().Split('|')[0]);
            string key = json.ToString().Split('|')[1];
            File.AppendAllText(@"C:\Pipes\json.txt", $" {threadID} {key}");
            ret[threadID] = supers[key];
        }

        private static PipeSecurity SetupPipeSecurity()
        {
            PipeSecurity pipeSecurity = new PipeSecurity();
            System.Security.Principal.SecurityIdentifier sid = new System.Security.Principal.SecurityIdentifier(System.Security.Principal.WellKnownSidType.WorldSid, null);
            pipeSecurity.AddAccessRule(new PipeAccessRule(sid, PipeAccessRights.CreateNewInstance, AccessControlType.Allow));
            pipeSecurity.AddAccessRule(new PipeAccessRule(sid, PipeAccessRights.FullControl, AccessControlType.Allow));
            return pipeSecurity;
        }


        protected override void OnStart(string[] args)
        {
            if (!System.Diagnostics.EventLog.SourceExists("RiddlerLog"))
            {
                EventLog.CreateEventSource("Penguin", "RiddlerLog");
            }
            else
            {
            }

            //Task.Delay(1000).ContinueWith(t => ServerThread());

            eventLogger.Source = "Penguin";
            eventLogger.Log = "RiddlerLog";
            eventLogger.WriteEntry($"In OnStart {servers[0].IsAlive} {servers[0].IsBackground} {servers[0].ThreadState}" + String.Join("-", args));
        }

        protected override void OnStop()
        {
            eventLogger.WriteEntry("In OnStop ");
            for (i = 0; i < numThreads; i++)
            {
                servers[i] = null;
            }
        }
    }
}
